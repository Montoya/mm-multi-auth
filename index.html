<!DOCTYPE html>
<html>
<head>
  <title>MetaMask multi-auth example</title>
  <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Geist:wght@400..700&display=swap" rel="stylesheet">
  <style type="text/css">
    body { 
      background-color:#223; 
      font-family:'Geist', sans-serif; 
    }
    .card { 
      width:600px; 
      margin:2em auto; 
      padding:18px 24px;
      background-color:inherit;
      border:2px solid #668; 
      border-radius:8px;
    }
    .icon { 
      width:24px;
      height:24px; 
      margin-right:12px; 
      vertical-align:bottom;
      position:relative;
      top:-1px; 
    }
    .found { 
      display:none; 
    }
    .card p { 
      padding-top:8px; 
    }
    .card p .btn, .card li .btn { 
      float:right; 
      vertical-align:bottom;
      position:relative;
      top:-1px;
    }
    .card li .btn { 
      top:4px;
    }
    #accounts ul { 
      list-style-type:none;
      margin-left:0; 
    }
    #accounts ul li { 
      border-top:1px solid #668; 
      padding-top:1em; 
    }
    #explanation { 
      width:600px; 
      margin:1em auto; 
    }
    #explanation a { 
      text-decoration:underline;
    }
  </style>
</head>
<body>

  <div id="page" class="card text-light">
    <h1 class="h3">Detected Wallets</h1>
    <div id="loading" class="loading loading-lg">Detecting...</div>
  </div>

  <div id="accountContainer" class="card text-light" style="display:none">
    <h2 class="h3">Connected Accounts</h2>
    <div id="accounts"></div>
    <p>
      <button id="connectMore" class="btn btn-primary btn-sm">Connect more accounts</button>
    </p>
  </div>

  <div id="explanation" class="text-light">This demonstrates how to cleanly detect MetaMask or MetaMask Flask and authorize multiple EVM accounts. It allows the user to authorize multiple accounts, add more accounts at any time, and even trigger a fresh request after switching the "active" account in MetaMask. However, it does not attempt to verify signatures or store any information. <a class="text-light" href="https://github.com/Montoya/mm-multi-auth#readme">View code on GitHub</a></div>

  <script type="text/javascript">

let provider; 

const handleAccounts = async (accounts) => { 
  document.getElementById("accounts").textContent = ''; 
  if(accounts && accounts.length && accounts.length > 0) { 
    // result is an array of addresses
    const ul = document.createElement("ul"); 
    accounts.forEach((account) => { 
      const btn = document.createElement("button"); 
      btn.textContent = "Link";
      btn.className = "btn btn-primary btn-sm";
      btn.dataset.account = `${account}`; 
      btn.addEventListener("click",(e) => { 
        provider.request({
          "method": "personal_sign",
          "params": [
            "0x506c65617365207369676e2074686973206d65737361676520746f20636f6e6669726d20796f7572206964656e746974792e",
            e.target.dataset.account
          ],
        }).then(() => {e.target.textContent = "Done"}).catch(err => console.log(err));
      });
      const p = document.createElement("p"); 
      p.textContent = `${account}`; 
      const li = document.createElement("li"); 
      li.appendChild(btn);
      li.appendChild(p);  
      ul.appendChild(li); 
    }); 
    document.getElementById("accounts").appendChild(ul);
    document.getElementById("page").style.display = "none";
    document.getElementById("accountContainer").style.display = "block";  
  }
  else { 
    document.getElementById("page").style.display = "block";
    document.getElementById("accountContainer").style.display = "none"; 
  }
}; 

const MetaMaskFound = async (providerDetail) => { 

  document.getElementById('loading').className = "found"; 

  const row = document.createElement("p"); 
  const icon = document.createElement("img"); 
  icon.className = "icon"; 
  icon.src = providerDetail.info.icon; 
  row.appendChild(icon); 
  const label = document.createElement("span"); 
  label.textContent = providerDetail.info.name; 
  row.appendChild(label); 
  const btn = document.createElement("button"); 
  btn.className = "btn btn-primary btn-sm"; 
  btn.textContent = "Connect Accounts"; 

  provider = providerDetail.provider; 

  provider.on("accountsChanged",handleAccounts); 

  document.getElementById("connectMore").addEventListener("click",(e)=>{
    provider.request({
      "method": "wallet_requestPermissions",
      "params": [
        {
          eth_accounts: {}
        }
      ],
    }).then((result) => {
      // this method triggers a fresh connection request, even though one already exists. the user can modify the permitted accounts in this flow
      // the return value of this method is not a standard return value, but we can ignore that, because if the user changes the set of permitted accounts, 
      // the "accountsChanged" event will fire and that will be handled by the associated event listener
    }).catch(err => console.log(err)); 
  }); 

  // if an active connect is already available, re-fetch the accounts
  provider.request({ 
   "method": "eth_accounts",
    "params": [],
  }).then(handleAccounts); 

  btn.onclick = async (event) => { 
    event.preventDefault(); 
    try { 
      const result = await provider.request({
        "method": "eth_requestAccounts",
        "params": [],
      }); 
    }
    catch { 
      // fail silently. user can just try to connect again. 
    }
  }; 
  row.appendChild(btn); 
  document.getElementById('page').appendChild(row); 

}; 

window.onload = function() {

  window.addEventListener(
    "eip6963:announceProvider",
    (event) => {
      /* event.detail contains the discovered provider interface */ 
      const providerDetail = event.detail; 
      
      /* 
       * You could take one of these cases and use it for your needs,
       * or set up a conditional that takes any of these possibilities, 
       * or prompt the user to choose which MetaMask flavor they want to use 
       * in case they have multiple MetaMask extensions installed at the same time
       */
      if(providerDetail.info.rdns == "io.metamask") { 
        /* this is MetaMask */
        MetaMaskFound(providerDetail); 
      }
      else if(providerDetail.info.rdns == "io.metamask.flask") { 
        /* this is MetaMask Flask */ 
        MetaMaskFound(providerDetail); 
      }
      else if(providerDetail.info.rdns == "io.metamask.mmi") { 
        /* this is MetaMask Institutional */ 
        MetaMaskFound(providerDetail); 
      }
    }
  );

  window.dispatchEvent(new Event("eip6963:requestProvider"));

  setTimeout(() => { 
    if("found"!==document.getElementById('loading').className) { 
      /* Assume MetaMask was not detected */
      document.getElementById('loading').className = "none"; 
      document.getElementById('loading').textContent = "MetaMask was not found. This demo only works with MetaMask!";  
    }
  }, 1000)

}

  </script>
</body>
</html>